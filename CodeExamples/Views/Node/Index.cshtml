@section Head{
    <script src="@Url.Content("~/Scripts/underscore.min.js")" type="text/javascript"> </script>
    <script src="@Url.Content("~/Scripts/backbone.min.js")" type="text/javascript"> </script>
    <script src="@Url.Content("~/Scripts/handlebars-1.0.0.beta.6.js")" type="text/javascript"> </script>
    <script src="@Url.Content("~/Scripts/jquery-ui-1.8.18.custom.min.js")" type="text/javascript"> </script>
    
    <script type="text/javascript">
        (function ($) {
            $(function () {

                var NodesView = Backbone.View.extend({
                    render: function (event) {
                        var that = this;
                        this.setElement($('#main-node'));
                        this.nodeViews = _.map(this.model, function (n) {
                            var view = new NodeView({ model: n });
                            return view.render();
                        });
                        _(this.nodeViews).chain().filter(function (n) { return n.model.Parent === null && n.model.Before === null; }).each(function (n) { that.$el.append(n.el); });

                        var viewFinder = function (id) {
                            return _(that.nodeViews).chain().filter(function (n) { return n.model.Id === id; }).first().value();
                        };
                        _(this.nodeViews).each(function (n) { n.postRender(viewFinder); });
                        return this;
                    }
                });

                var NodeView = Backbone.View.extend({
                    templateId: '#nodeTemplate',
                    initialize: function () {
                        _.bindAll(this);
                    },
                    events: {
                        "dragstop .node": "dropped"
                    },
                    render: function (event) {
                        var template = Handlebars.compile($(this.templateId).html());
                        this.setElement(template(this.model));
                        this.$('> .node').draggable({ stack: '.node' });
                        return this;
                    },
                    postRender: function (viewFinder) {
                        if (this.model.Before !== null) {
                            viewFinder(this.model.Before).$el.insertAfter(this.el);
                        } else if (this.model.Parent !== null) {
                            viewFinder(this.model.Parent).$('ul').append(this.el);
                        }
                    },
                    dropped: function (evt, ui) {
                        this.$('> .node').animate({ top: 0, left: 0 }, 'fast');
                    }
                });

                window.app = new NodesView();

                $.post('@Url.Action("Nodes")', function (data) {
                    app.model = data;

                    app.render();

                    $('.node').draggable();
                });
            });
        })(jQuery);
    </script>
}
<h2>Site</h2>
<ul id="main-node" class="nodes">
        
</ul>

<script id="nodeTemplate" type="text/handlebars-template">
    <li>
        <div class="node">
            <h3 class="title">{{Title}}</h3>
        </div>
        <ul class="nodes">
        
        </ul>
    </li>
</script>